# 事前調査

## 1. Google Places API

### 1.1 料金体系（2025年12月調査）

**無料枠**: 月$200のクレジット（全SKU共通）

| Tier | Place Details料金（/1000件） | $200で使える回数 |
|------|------------------------------|------------------|
| Essentials | $5.00 | 約40,000回 |
| Pro | $17.00 | 約11,700回 |
| Enterprise | $20.00 | 約10,000回 |

**Place Search（Nearby Search）**:
- Pro tier: $32.00 / 1,000リクエスト → 約6,250回/月
- Enterprise tier: 同等

**Tierの違い**:
- Essentials: 基本フィールドのみ（名前、住所、評価など）
- Pro: 拡張データ（営業時間、写真など）
- Enterprise: 高度なデータ（雰囲気情報など）

> **参考**: https://developers.google.com/maps/documentation/places/web-service/usage-and-billing

### 1.2 レート制限

- QPSベースで管理（具体的な数値はドキュメントに明記なし）
- 無料枠を超えた場合は課金が発生
- IDのみの取得は無制限

### 1.3 取得可能なデータ

- [x] 評価（rating）: 1.0〜5.0
- [x] レビュー数（user_ratings_total）
- [x] レビュー本文
- [x] 営業時間
- [x] 写真

**料金の関係**: Essentials tierでは基本フィールドのみ、Pro/Enterpriseでより詳細なフィールドにアクセス可能。

### 1.4 API キーの取得方法

- [x] Google Cloud Console でプロジェクト作成
- [x] Places API を有効化
- [x] API キー発行
- [x] リファラ制限の設定方法（APIキー設定画面で設定可能）

---

## 2. 食べログのDOM構造

### 2.1 対象ページ

| ページ種別 | URL パターン | 対応優先度 |
|-----------|-------------|-----------|
| 店舗詳細 | `tabelog.com/*/A*/A*/*/` | 高 |
| 検索結果 | `tabelog.com/*/rstLst/*` | 中 |
| ランキング | `tabelog.com/*/rank/*` | 低 |

### 2.2 店舗詳細ページの構造（2025年12月調査）

```
- 店名: .display-name クラス
- 住所: .rstinfo-table__address クラス内の SPAN 要素
- 評価表示挿入先: .js-header-rating または .rdheader-rstname
```

**注意**: 住所はプレーンテキストではなくHTML構造になっているため、childNodesをループしてテキストを抽出する必要がある。

### 2.3 検索結果ページの構造

```
- 各店舗リスト: .list-rst クラス
- 店名: .list-rst__rst-name-target クラス
- 住所情報: 詳細ページとは異なるセレクタ（要検証）
```

### 2.4 注意点

- [x] SPAかどうか: 基本的にMPA（従来型のページ遷移）
- [x] ページ遷移時のDOM更新: DOMContentLoadedで発火可能
- [x] ログイン状態による差異: 基本的な店舗情報には影響なし

---

## 3. Chrome拡張の仕様

### 3.1 Manifest V3

2024年以降、Chrome拡張はManifest V3が必須。

主な制約:
- [x] Service Worker ベース（バックグラウンドページ廃止）→ Content Scriptのみの実装なら不要
- [x] リモートコード実行の禁止 → 影響なし（ローカルコードのみ）
- [x] 宣言的なネットワークリクエスト制御 → 影響軽微

> **参考**: https://developer.chrome.com/docs/extensions/develop/migrate/what-is-mv3

### 3.2 必要な権限

| 権限 | 用途 | 必須 |
|------|------|------|
| `activeTab` | 現在のタブの情報取得 | Yes |
| `host_permissions` | 食べログドメインへのアクセス | Yes |
| `storage` | 設定・キャッシュ保存 | Maybe |

### 3.3 Content Script vs Background Script

- Content Script: ページのDOMにアクセス可能
- Background Script (Service Worker): API呼び出し等

→ 両方必要になる可能性が高い

---

## 4. 競合調査（2025年12月調査）

### 4.1 既存の類似拡張機能

| 名前 | 機能 | ユーザー数 | 備考 |
|------|------|-----------|------|
| 食べログ GoogleMap評価追加 | Google Maps評価をページ内表示 | 167 | Cloud Functions + Places API使用、利用制限あり |
| 食べログ地図強化プラグイン | 地図のお気に入り場所保存 | 不明 | 評価表示機能なし |
| Sinhalite氏の拡張（Qiita記事） | Google Mapsへのリンク生成 | 非公開 | API不使用、vanilla JS |

### 4.2 差別化ポイント

- [x] **Manifest V3対応**: 既存拡張がV2の場合は優位性あり
- [x] **APIキー不要オプション**: リンク方式ならユーザー設定不要
- [x] **メンテナンス継続**: 既存拡張のメンテナンス状況が不明なものが多い
- [x] **最新DOM対応**: 食べログのDOM変更に追従

---

## 5. 利用規約・法的リスク（2025年12月調査）

### 5.1 食べログ利用規約

- [x] **スクレイピングに関する記載**: 第6条(1)で営利目的のスクレイピングは禁止
- [x] **データの二次利用**: 第9条で事前同意なしの複写・複製・再配布は禁止
- [x] **個人利用の範囲**: 明確な定義なし（営利目的でなければグレーゾーン）
- [x] **ブラウザ拡張機能**: 規約に明記なし

> **参考**: https://tabelog.com/help/rules/

### 5.2 Google Maps Platform 利用規約

- [x] **帰属表示**: 「Google Maps」のクレジット表示が必須
- [x] **表示要件**: 帰属を削除・変更・隠蔽してはいけない
- [x] **使用制限**: 一般的なAPI利用制限が適用
- [x] **ブラウザ拡張機能**: 特別な規定なし（一般ルール適用）

> **参考**: https://cloud.google.com/maps-platform/terms

### 5.3 リスク評価

| リスク | 可能性 | 影響度 | 対策 |
|--------|--------|--------|------|
| 食べログからのブロック | 低 | 低（個人利用）| DOM情報の取得のみでサーバー負荷なし |
| 規約違反による警告 | 低 | 中 | 非営利・個人利用に留める |
| Google帰属表示違反 | 低 | 中 | リンク方式なら帰属表示不要 |

---

## 6. 調査まとめ

### 6.1 Go / No-Go 判断

- [x] **技術的に実現可能か**: ✅ 可能。既存の類似拡張が動作しており、DOM構造も判明済み
- [x] **法的リスクは許容範囲か**: ✅ 許容範囲。個人利用・非営利でリンク方式なら問題なし
- [x] **開発コスト（時間）は妥当か**: ✅ 妥当。リンク方式（Option B）なら4-5時間で実装可能

**結論: Go** 🟢

### 6.2 推奨アプローチ

| 方式 | 推奨度 | 理由 |
|------|--------|------|
| Option B（リンクのみ） | ⭐⭐⭐ | 実装簡単、API不要、リスク最小 |
| Option A（API方式） | ⭐⭐ | 高機能だが設定が必要、コスト発生 |

**推奨**: まずOption Bで実装し、需要があればOption Aを追加

### 6.3 残課題

| 課題 | ステータス | 備考 |
|------|------------|------|
| 実際のDOM検証 | 未着手 | 開発時に実ページで確認 |
| 検索結果ページ対応 | 未着手 | Phase 2で検討 |
